<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script src="https://cdn.aerisapi.com/sdk/js/1.8.4/aerisweather.min.js"></script>
	<link rel="stylesheet" href="css/aerisweather.css">
	<link rel="stylesheet" href="css/attrib.css">


    <style>
    body, html {
        margin: 0;
        padding: 0;
    }
    #map {
        height: 100vh;
        width: 100%;
    }


	.btn-play {

	  font-family: "Helvetica", "Arial", sans-serif;
	  font-size: 11px;
	  color:black;
	  font-weight: 400;
    }
	.btn-pause {

	  font-family: "Helvetica", "Arial", sans-serif;
	  font-size: 11px;
	  color:black;
	  font-weight: 400;
	}


.btn-play {
    background: rgba(255, 255, 255, 0.1);
    border: 0;
    border-radius: 4px;
    color: #575757;
    cursor: pointer;
    display: inline-block;
    font-size: 11px;
    font-weight: bold;
    padding: 2px 3px;
    position: relative;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border: 1px solid #4f4f4f85;
}




    #controls {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 8px;
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 1;
        background: rgba(255, 255, 255, 0.8);
        padding: 6px;
        border-radius: 5px;

    }
	

    #controls2 {
        display: flex;
        flex-direction: column;
        justify-content: center;

        gap: 3px;
        position: absolute;
        top: 8px;
        left: 10px;
        z-index: 1;
        background: rgba(255, 255, 255, 0.8);
        padding: 4px;
        border-radius: 4px;
    }
	
	
	    #controls3 {
        display: flex;
        flex-direction: column;
        justify-content: center;

        gap: 30px;
        position: absolute;
        bottom: 12px;
        right: 15px;
        z-index: 1;
        background: rgba(255, 255, 255, 0.8);
        padding: 4px;
        border-radius: 2px;
    }
	

    </style>


</head>

<body>		
	
<div id="map"></div>

    <div id="controls3">

	<img src="assets/logos/kaosmod.png" alt="KAOS">	

    </div>


    <div id="controls2">
		<button class="btn-play" onclick="location.href='desktopX1.html';">IntelliSTAR</button>
		<button class="btn-play" onclick="location.href='WX_APP_standalone.html';">INFO Mode</button>


    </div>
	

<script>

	getParameter = (key) => { 
	  
		// Address of the current window 
		address = window.location.search 
	  
		// Returns a URLSearchParams object instance 
		parameterList = new URLSearchParams(address) 
	  
		// Returning the respected value associated 
		// with the provided key 
		return parameterList.get(key) 
	} 
	  
	// Gets the value associated with the key "lng and lat" 
	console.log(getParameter("lng"))
	console.log(getParameter("lat"))
	console.log(getParameter("zm"))


	var lng = (getParameter("lng"))
	var lat = (getParameter("lat"))
	var zoom = (getParameter("zoom"))


	 
	window.addEventListener('load', () => { 
		
	const aeris = new AerisWeather('wgE96YE3scTQLKjnqiMsv', 'SVG2gQFV8y9DjKR0BRY9wPoSLvrMrIqF9Lq2IYaY');	
	const utils = aeris.utils;

	aeris.apps().then((apps) => {
		const app = new apps.InteractiveMapApp(document.getElementById('map'), {
            map: {
                strategy: "mapbox",
                accessToken: "pk.eyJ1IjoiYWNjdXdlYXRoZXItaW5jIiwiYSI6ImNqeGtxeDc4ZDAyY2czcnA0Ym9ubzh0MTAifQ.HjSuXwG2bI05yFYmc0c9lw",
                zoom: 5,
				style:'mapbox://styles/accuweather-inc/cjknc24na2o5u2sqoy0t8ku8a',
				
				layers: 'radar, temperatures-24hr-change',
				
                center: {
                    lat: 38.8,
                    lon: -95.47

                    //lat: lat,
                    //lon: lng
                },

                timeline: {

            	    bufferIntervals: 3,
            	    //showLoadingIntervals: false,
				    //bufferIntervals: -1,
					showLoading: false,
					duration: 7,
					endDelay: 4,			
                    from: -7200,
                    to: 3600
					
                },


			},

            panels: {
                layers: {
                    buttons: [
					
						{
                            title: "Dark Base Map",
                            value: "flat-dk"

                        },					
					
					],
					title: '',
                    enabled: true,
                    toggleable: true,
                    position: {
                        pin: "topright",
                        translate: {
                            x: -8,
                            y: 8
                        }
                    }
                },


			
                    timeline: {
						//title: '',
						enabled: true,
						toggleable: true,
						position: {
							pin: "bottomleft",
							translate: {
								x: 8,
								y: -8
							}
						},
					
                        range: {
                            // set the initial timeline offset range value
                            value: [-6, 0],

                            // set the min and max time offsets for the timeline range
                            range: {
                                min: -12,
                                max: 1
                            },

                            // define the tick labels that should be rendered along the slider
                            marks: {
                                '-12': '-12',
								'-10': '-10',
                                '-8': '-8',
                                '-6': '-6',
                                '-4': '-4',
                                '-2': '-2',
								 0: 'Now',
                                 1: '+1',
                            },

                            // the value interval to render tick marks for, e.g. every 6 hours
                            step: 2
                        }
                    },				
				
				
                search: {
                    enabled: true,
                    toggleable: false,
                    position: {
                        pin: "top",
                        translate: {
                            x: -2,
                            y: 10
                        }
                    }
                },
				
                legends: {
                    enabled: false,
                    toggleable: true,
                    position: {
                        pin: "bottomleft",
                        translate: {
                            x: 10,
                            y: -110
                        }
                    }
                },
				
                info: {
                    enabled: true,
                    position: {
                        pin: "topleft",
                        translate: {
                            x: 10,
                            y: 10
                        }
                    },
                    metric: false
                }
            }
        });

////////////////////////////////////////////////////////////////////////////////////////////////////

		app.on('ready', () => {

			aeris.mapsgl(app, {
				version: '1.3.5', //*************************************************
				layers: [
				
				
					{
                        title: "Storm Cells",
                        value: "stormcells",
						options: {
								paint: {
				
									fill: {
										opacity: 0.5
									},

									stroke: {

										opacity: .5
									}

								},
							},
							
					},

					
					
					{
						title: 'Storm Reports', 
						value: 'stormreports', 
						options: {
									paint: {
										fill: {
											opacity: 0.45
										},
										stroke: {
											opacity: .25
										}
									},
							},
							
					},							
					


				{ title: 'Lightning Data', value: 'lightning', segments: [



	

					{
						title: "Lightning Flash",
						value: "lightning-flash"
					},				
				
					{
						title: "Lightning All",
						value: "lightning-all"
					},
						
						
					],				

					
				},


	
				],

				})
				
			
							.then(({controller, mapsgl }) => {
	

							// ADD STUFF

	

							});


		
			// load in MapsGL sdk and set up relevant layer controls
			aeris.mapsgl(app, {
				version: '1.5.2', //***********************************  
				layers: [
				
				
									{
										id: "lightningStrikesCustom",
										title: "Lightning Strikes",
										value: "lightning-strikes",											
										options: {
										type: 'symbol',
										paint: {
										symbol: {
										shader: `
										#extension GL_OES_standard_derivatives : enable
								 
										precision mediump float;
								 
										uniform vec2 resolution;
										uniform float dpr;
										uniform float time;
								 
										varying vec2 vUv;
										varying vec2 vPosition;
										varying float vFactor;
										varying float vRandom;
								 
										float rand(float x) {
											return fract(sin(x)*75154.32912);
										}
								 
										float rand3d(vec3 x) {
											return fract(375.10297 * sin(dot(x, vec3(103.0139,227.0595,31.05914))));
										}
								 
										float noise(float x) {
										float i = floor(x);
										float a = rand(i), b = rand(i+1.);
										float f = x - i;
											return mix(a,b,f);
										}
								 
										float perlin(float x) {
											float r=0.,s=1.,w=1.;
											for (int i=0; i<6; i++) {
												s *= 2.0;
												w *= 0.5;
												r += w * noise(s*x);
											}
											return r;
										}
								 
										float noise3d(vec3 x) {
											vec3 i = floor(x);
											float i000 = rand3d(i+vec3(0.,0.,0.)), i001 = rand3d(i+vec3(0.,0.,1.));
											float i010 = rand3d(i+vec3(0.,1.,0.)), i011 = rand3d(i+vec3(0.,1.,1.));
											float i100 = rand3d(i+vec3(1.,0.,0.)), i101 = rand3d(i+vec3(1.,0.,1.));
											float i110 = rand3d(i+vec3(1.,1.,0.)), i111 = rand3d(i+vec3(1.,1.,1.));
											vec3 f = x - i;
											return mix(mix(mix(i000,i001,f.z), mix(i010,i011,f.z), f.y),
												mix(mix(i100,i101,f.z), mix(i110,i111,f.z), f.y), f.x);
										}
								 
										float perlin3d(vec3 x) {
											float r = 0.0;
											float w = 1.0, s = 1.0;
											for (int i=0; i<5; i++) {
												w *= 0.5;
												s *= 2.0;
												r += w * noise3d(s * x);
											}
											return r;
										}
								 
										#define COL1 vec4(0, 0, 0, 0) / 255.0
										#define COL2 vec4(235, 241, 245, 255) / 255.0
								 
										#define SIZE 100
										#define FLASH_POWER .8
										#define RADIUS .001
										#define SPEED .0018
										#define SEED 
								 
										void main() {
											vec2 pos = vUv;
								 
											float dist = length(2.0 * pos - 1.0) * 2.0;
											float x = time + 0.1;
								 
											float m = 0.2 + 0.2 * vFactor; // max duration of strike
											float i = floor(x/m);
											float f = x/m - i;
											float k = vFactor; // frequency of strikes
											float n = noise(i);
											float t = ceil(n-k); // occurrence
											float d = max(0., n-k) / (1.-k); // duration
											float o = ceil(t - f - (1. - d)); // occurrence with duration
								 
											float fx = 4.;
											if (o == 1.) {
												fx += 10. * vFactor;
											}
								 
											fx = max(4., fx);
											float g = fx / (dist * (10. + 20.)) * FLASH_POWER; 
								 
											// smooth out edges to avoid fading extending beyond the symbol's bounds
											float edgeFadeFactor = smoothstep(0.5, 1.0, dist);
											float invertedEdgeFadeFactor = 1.0 - edgeFadeFactor;
								 
											vec4 color = mix(COL1, COL2, g);
											color.a *= min(1.0, 0.5 + vFactor) * invertedEdgeFadeFactor;
											
											gl_FragColor = color;
											gl_FragColor.rgb *= gl_FragColor.a;
											}
														`,
														size: { width: 60, height: 60 },
														animated: true,
														blending: 2,
														pitchWithMap: true,
														allowOverlap: true,
														factor: (data) => {
															const max = 200;
															return (200 - data.age) / 200;
														}
													}
												}
										}	

									},				
				
				
				
	
						{ title: 'Heat Maps', value: 'Heat Maps', segments: [,

						{
						title: "Lightning ",
						value: "lightning-strike-density",

						},

						{
                        title: "Storm Cells",
                        value: "stormcells-heat",
						},


						], 
					
							options: {
								paint: {
									opacity: .6
								}
							},

						},

	
	
                        { title: 'Particles', value: 'winds', segments: [

						{
                        title: "Wind Particles",
                        value: "wind-particles"
						},

						{
                        title: "Ocean Particles",
                        value: "ocean-currents-particles"
						}
											
						] },

	
                        { title: 'Radar', value: 'Radar', segments: [
	
						{
                        title: "Radar",
                        value: "radar"
						
						},
					
						{
                        title: "Clouds",
                        value: "cloud-cover"
						},

								{
                        title: "Satellite",
                        value: "satellite"
						},						

								{
                        title: "Infared Satellite",
                        value: "satellite-infrared-color"
						}	


						],

							options: {
								paint: {
									opacity: .75
								}

							},
	
						},

			
						
                     { title: 'Temp Change', value: 'temp-change', segments: [
					 
						{
                        title: "Past 24 hours",
                        value: "temperatures-24hr-change"
						},
						
						{
                        title: "Past 1 hour",
                        value: "temperatures-1hr-change"
						},
					

						],

							options: {
								paint: {
									opacity: .25
								}
							},
	
						},

						{
						title: 'Heat Index', 
						value: 'heat-index', 
						options: {
							paint: {
								opacity: .05
								}
							}			
						},

						{
						title: 'Wind Chill', 
						value: 'wind-chill', 
						options: {
							paint: {
								opacity: .1
								}
							},
						
						},

						
                        { title: 'Winds', value: 'winds', segments: [
                            { title: 'Arrows', value: 'wind-dir' },						
                            { title: 'Barbs', value: 'wind-barbs' }
                        ] },



						{
						title: 'Visibility', 
						value: 'visibility', 
						options: {
							paint: {
								opacity: .2
								}
							}			
						},
						

						{
						title: 'Drought Monitor', 
						value: 'drought-monitor', 
						options: {
							paint: {
								opacity: .4
								}
							}			
						},	

	
						{ title: 'Oceanic Data', value: 'ocean-currents', segments: [


						{
						title: "Ocean Currents",
						value: "ocean-currents"

						},

						{
						title: "Storm Surge Height",
						value: "storm-surge"
						},

						{
						title: "Surface Temperature",
						value: "sst"
						}
		
						], 
					
							options: {
								paint: {
									opacity: .3
								}
							},

						},


					]
					
				})
				
				
				

			

			.then(({controller, mapsgl }) => {


					
			
				
				// configure views for local weather info panel
				app.panels.info.setContentView('localweather', {
                views: [{
                        renderer: "alerts"
                    },{
                        renderer: "threats"
                    },{
                        renderer: "outlook"
                    },{
                        renderer: "place"
                    }]
				});
				

			
				// show info panel for location when map is clicked
				app.map.on('click', (e) => {
					app.showInfoAtCoord(e.data.coord, 'localweather', 'Local Weather');
				});		


						//add the MapsGL legend control
						//controller.addLegendControl(app.$el, { width: 200 });


						// add the MapsGL data inspector control*********************
						controller.addDataInspectorControl({ event: 'move'}); //must be here
						
						
						//app.getPanel('layers').select(['lightning-strikes']);
						

							
						//controller.addWeatherLayer('heat-index');
		

						controller.addWeatherLayer('tide-heights', {
							"paint" : {
								"opacity" : .12
							},
						},
						 "aeroway-line"			

						);
						
						
				
						//Alerts for data inspector
						controller.addWeatherLayer('alerts', { paint: {	fill: {	opacity: 0.0 }, stroke: { opacity: .0 } }, }, "aeroway-line" );				
						


						controller.addWeatherLayer('stormreports', {
								paint: {
				
									fill: {
										opacity: 0
									},

									stroke: {

										opacity: 0
									}

								},

							},
							 "aeroway-line"
						);	


						controller.addWeatherLayer('stormcells', {
								paint: {
				
									fill: {
										opacity: 0
									},

									stroke: {

										opacity: 0
									}

								},

							},
							 "aeroway-line"
						);			

						
						controller.addWeatherLayer('wind-speeds-contour', {
							"paint" : {
								"opacity" : 0
							},
						},
						 "aeroway-line"			
					
						);						


						controller.addWeatherLayer('humidity', {
							"paint" : {
								"opacity" : 0
							},
						},
						 "aeroway-line"			

						);

						controller.addWeatherLayer('dew-points', {
							"paint" : {
								"opacity" : 0
							},
						},
						 "aeroway-line"			
						
						);


						controller.addWeatherLayer('feels-like', {
							"paint" : {
								"opacity" : 0
							},
						},
						 "aeroway-line"			
						
						);			

						
						controller.addWeatherLayer('temperatures-24hr-change', {
							"paint" : {
								"opacity" : .3
							},
						},
						 "aeroway-line"			
						
						);					
						
						
						controller.addWeatherLayer('temperatures-contour', {
							"paint" : {
								"opacity" : 0
							},
						},
						 "aeroway-line"			
						
						);


						controller.addWeatherLayer('pressure-msl-contour', {
							"paint" : {
								"opacity" : 0
							},
						},
						 "aeroway-line"			

						);


						controller.addWeatherLayer('fires-outlook', {
							"paint" : {
								"opacity" : .48
							},
						},
						 "aeroway-line"			

						);

						controller.addWeatherLayer('earthquakes-heat', {
							"paint" : {
								"opacity" : .5
							},
						},
						 //"aeroway-line"			

						);
						
						controller.addWeatherLayer('earthquakes', {
							type: 'symbol',
							source: 'earthquakes',
							paint: {
								symbol: {
									shader: `
						// https://www.shadertoy.com/view/ldycR3
						#extension GL_OES_standard_derivatives : enable
			 
						precision mediump float;
			 
						uniform vec2 resolution;
						uniform float dpr;
						uniform float time;
			 
						varying vec2 vUv;
						varying vec2 vPosition;
						varying float vFactor;
						varying float vRandom;
			 
						float saturate(float x) {
						return clamp(x, 0.0, 1.0);
						}
			 
						vec3 hsb2rgb(in vec3 c) {
						vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,
									0.0,
									1.0);
						rgb = rgb*rgb*(3.0-2.0*rgb);
						return c.z * mix( vec3(1.0), rgb, c.y);
						}
			 
						void main() {
						vec2 pos = vUv;
						float t = time;
			 
						float dist = length(2.0 * pos - 1.0) * 2.0;
						vec2 p = vec2(dist);
			 
						float r = length(p) * 0.9;
						vec3 color = hsb2rgb(vec3(0.03, 0.7, 0.6));
			 
						float a = pow(r, 3.0);
						float b = sin(r * 1.8 - 1.6);
						float c = sin(r - 0.010);
						float s = sin(a - t * 2.0 + b) * c;
			 
						color *= abs(1.0 / (s * 1.8)) - 0.01;
			 
						float d = length(2.0 * pos - 1.0);
						// float delta = fwidth(d);
						float alpha = 1.0 - d;
						// alpha *= min(1.0, 0.2 + vFactor);
			 
						gl_FragColor = vec4(color, alpha);
						gl_FragColor.rgb *= gl_FragColor.a;
						}
									`,
									animated: true,
									pitchWithMap: true,
									// blending: 2,
									size: (data) => {
										const mag = Math.max(data.report?.mag || 1);
										const size = 1 + 115 * (mag / 10);
										return { width: size, height: size };
									}
								}
							}
						}, "aeroway-line");



						

						controller.addWeatherLayer('convective-outline', {
							"paint" : {
								"opacity" : .50
							},
						},
						 "aeroway-line"			
						
						);
						

						controller.addWeatherLayer('convective', {
							"paint" : {
								"opacity" : .30
							},
						},
						 "aeroway-line"			

						);									

						controller.addSource('alerts', {
							type: 'vector',
							url: 'https://maps{s}.aerisapi.com/wgE96YE3scTQLKjnqiMsv_SVG2gQFV8y9DjKR0BRY9wPoSLvrMrIqF9Lq2IYaY/alerts/{z}/{x}/{y}/0.pbf'
						});
						 
						controller.addLayer('alerts-fill', {
							type: 'fill',
							source: 'alerts',
							paint: {
								fill: {
									opacity: .70,
									color: {
										property: 'COLOR'
									}
								},
								stroke: {
		
									color: '#000',
									opacity: .45,
						
								}
							}
						}, "aeroway-line"	 );			
						




						app.getPanel('layers').select(['lightning-strikes']);


						//app.map.addLayers(['alerts:52']);

		        		//add the MapsGL legend control
             		    //controller.addLegendControl(app.$el, { width: 200 });

	
						// add the MapsGL data inspector control*********************
						//controller.addDataInspectorControl({ event: 'move'}); //must be here


                			// add Tropical module from the Javascript SDK
						aeris.modules().then((modules) => {
							const layerModules = [{
								name: "groups.Tropical",
								index: 18
							},


						//{
								//name: "groups.Aviation",
								//index: 5
								//}


						];
							layerModules.forEach(({ name, index }) => {
								const m = utils.get(modules, name);
								if (m) {
									if (index !== -1) {
										app.modules.insertAt(index, m);
									} else {
										app.modules.add(m);
									}
								}
							});
						});

						//Add Severe Module
						
						//app.modules.add(new Severe());

						app.modules.insertAt(17, new Severe( {showThreats: true}));

						//app.modules.insertAt(17, new Severe());
						






				});
			



			});


	
		});	
								

	});



</script>	

<script src="js/awxjs-severe-weather.min.js"></script>

</body>


</html>